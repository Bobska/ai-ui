<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Console - My AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: #2d2d2d;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
        }

        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        nav a {
            color: #b0b0b0;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.2s;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        nav a:hover {
            color: #ffffff;
            background-color: #3a3a3a;
        }

        nav a.active {
            color: #4a9eff;
            font-weight: 500;
        }

        /* Main Container */
        main {
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Title */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            color: #ffffff;
        }

        .last-updated {
            color: #808080;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
        }

        /* Debug Toggle Section */
        .debug-toggle-section {
            background-color: #2d2d2d;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-info h2 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .toggle-info p {
            color: #b0b0b0;
            font-size: 0.95rem;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 80px;
            height: 40px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3a3a3a;
            transition: 0.3s;
            border-radius: 40px;
            border: 2px solid #4a4a4a;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 28px;
            width: 28px;
            left: 4px;
            bottom: 4px;
            background-color: #808080;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: rgba(74, 158, 255, 0.3);
            border-color: #4a9eff;
        }

        input:checked + .slider:before {
            transform: translateX(40px);
            background-color: #4a9eff;
        }

        .slider:hover {
            border-color: #5a5a5a;
        }

        input:checked + .slider:hover {
            border-color: #5aa8ff;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: #2d2d2d;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border-color: #4a4a4a;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #808080;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4a9eff;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
        }

        .stat-label {
            font-size: 0.95rem;
            color: #b0b0b0;
        }

        /* System Info Panel */
        .system-panel {
            background-color: #2d2d2d;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .system-panel h2 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            background-color: #1a1a1a;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .info-label {
            font-size: 0.85rem;
            color: #808080;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.1rem;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            word-wrap: break-word;
        }

        /* Memory Types Breakdown */
        .memory-breakdown {
            background-color: #2d2d2d;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 2rem;
        }

        .memory-breakdown h2 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: #ffffff;
        }

        .memory-type-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .memory-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            transition: border-color 0.2s;
        }

        .memory-type-item:hover {
            border-color: #4a4a4a;
        }

        .memory-type-name {
            font-size: 1rem;
            color: #e0e0e0;
            font-weight: 500;
        }

        .memory-type-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4a9eff;
            font-family: 'Courier New', monospace;
        }

        .memory-type-bar {
            flex: 1;
            height: 8px;
            background-color: #3a3a3a;
            border-radius: 4px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .memory-type-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #3a8eef);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem 2rem;
            color: #808080;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #3a3a3a;
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Error State */
        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: #ef4444;
        }

        .error-message h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .error-message p {
            color: #b0b0b0;
            font-size: 0.95rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: #4a4a4a;
        }

        .btn-primary {
            background-color: #4a9eff;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #3a8eef;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            nav {
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            main {
                padding: 1rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .debug-toggle-section {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>My AI Assistant</h1>
            <nav>
                <a href="index.html">Chat</a>
                <a href="memories.html">Memories</a>
                <a href="debug.html" class="active">Debug</a>
                <a href="settings.html">Settings</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="page-header">
            <h2 class="page-title">Debug Console</h2>
            <div class="last-updated" id="lastUpdated">Last updated: Never</div>
        </div>

        <div style="background: rgba(74, 158, 255, 0.1); border: 1px solid rgba(74, 158, 255, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
            <p style="color: #4a9eff; margin: 0;">
                📊 This page shows real-time statistics from your AI API. Data refreshes automatically every 5 seconds.
            </p>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" id="refreshBtn">
                🔄 Refresh Now
            </button>
            <button class="btn" id="autoRefreshBtn">
                ⏸️ Pause Auto-Refresh
            </button>
        </div>

        <!-- Debug Toggle Section -->
        <div class="debug-toggle-section">
            <div class="toggle-info">
                <h2>Debug Mode</h2>
                <p>Enable browser console logging for debugging (saved locally)</p>
                <p style="font-size: 0.85rem; color: #808080; margin-top: 0.5rem;">
                    Open browser DevTools (F12) to view console logs when enabled
                </p>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="debugToggle">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading stats...</p>
            </div>
        </div>

        <!-- System Info Panel -->
        <div class="system-panel" id="systemPanel" style="display: none;">
            <h2>
                <span class="status-indicator" id="statusIndicator"></span>
                System Information
            </h2>
            <div class="info-grid" id="systemInfo">
                <!-- System info will be populated here -->
            </div>
        </div>

        <!-- Memory Types Breakdown -->
        <div class="memory-breakdown" id="memoryBreakdown" style="display: none;">
            <h2>Memory Types Breakdown</h2>
            <div class="memory-type-list" id="memoryTypeList">
                <!-- Memory types will be populated here -->
            </div>
        </div>
    </main>

    <script>
        // Global state
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = true;
        const AUTO_REFRESH_INTERVAL = 5000; // 5 seconds

        // DOM elements
        const debugToggle = document.getElementById('debugToggle');
        const refreshBtn = document.getElementById('refreshBtn');
        const autoRefreshBtn = document.getElementById('autoRefreshBtn');
        const lastUpdated = document.getElementById('lastUpdated');
        const statsGrid = document.getElementById('statsGrid');
        const systemPanel = document.getElementById('systemPanel');
        const systemInfo = document.getElementById('systemInfo');
        const statusIndicator = document.getElementById('statusIndicator');
        const memoryBreakdown = document.getElementById('memoryBreakdown');
        const memoryTypeList = document.getElementById('memoryTypeList');

        // Initialize
        window.addEventListener('load', function() {
            loadStats();
            startAutoRefresh();
            loadDebugState();
        });

        // Debug toggle handler
        debugToggle.addEventListener('change', function() {
            toggleDebug(this.checked);
        });

        // Refresh button handler
        refreshBtn.addEventListener('click', function() {
            loadStats();
        });

        // Auto-refresh toggle handler
        autoRefreshBtn.addEventListener('click', function() {
            if (isAutoRefreshEnabled) {
                stopAutoRefresh();
                this.textContent = '▶️ Resume Auto-Refresh';
            } else {
                startAutoRefresh();
                this.textContent = '⏸️ Pause Auto-Refresh';
            }
        });

        // Start auto-refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            isAutoRefreshEnabled = true;
            autoRefreshInterval = setInterval(loadStats, AUTO_REFRESH_INTERVAL);
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            isAutoRefreshEnabled = false;
        }

        // Load stats from API
        async function loadStats() {
            try {
                // Fetch both stats and memories for accurate counts
                const [statsResponse, memoriesResponse] = await Promise.all([
                    fetch('http://localhost:8000/api/stats'),
                    fetch('http://localhost:8000/api/memories')
                ]);

                if (!statsResponse.ok && !memoriesResponse.ok) {
                    throw new Error(`HTTP error! status: ${statsResponse.status}`);
                }

                const statsData = statsResponse.ok ? await statsResponse.json() : {};
                const memoriesData = memoriesResponse.ok ? await memoriesResponse.json() : {};
                
                // Merge data - use memories data for accurate counts
                const data = {
                    ...statsData,
                    total_memories: memoriesData.total_count || statsData.total_memories || 0,
                    memories_by_type: memoriesData.memories_by_type || statsData.memories_by_type || {}
                };
                
                // Debug logging
                if (localStorage.getItem('debugMode') === 'true') {
                    console.log('Stats API Response:', data);
                }
                
                displayStats(data);
                updateLastUpdated();
                
                // Update status indicator
                statusIndicator.classList.remove('offline');

            } catch (error) {
                console.error('Error loading stats:', error);
                displayError('Unable to connect to the API. Please make sure the server is running.');
                
                // Update status indicator
                statusIndicator.classList.add('offline');
            }
        }

        // Display stats
        function displayStats(data) {
            // Show panels
            systemPanel.style.display = 'block';
            memoryBreakdown.style.display = 'block';

            // Clear loading state
            statsGrid.innerHTML = '';

            // Create stat cards
            const stats = [
                {
                    title: 'Total Memories',
                    value: data.total_memories || data.total_count || 0,
                    label: 'stored entries'
                },
                {
                    title: 'Memory Types',
                    value: data.memories_by_type ? Object.keys(data.memories_by_type).length : 0,
                    label: 'categories'
                },
                {
                    title: 'Model Name',
                    value: data.model_info?.name || data.model_name || data.model || 'Unknown',
                    label: 'AI model',
                    isText: true
                },
                {
                    title: 'Server Uptime',
                    value: formatUptime(data.uptime_seconds),
                    label: 'running time',
                    isText: true
                }
            ];

            // Add conversation count if available
            if (data.memories_by_type?.conversation) {
                const convCount = Array.isArray(data.memories_by_type.conversation) 
                    ? data.memories_by_type.conversation.length 
                    : data.memories_by_type.conversation;
                stats.push({
                    title: 'Conversations',
                    value: convCount,
                    label: 'chat sessions'
                });
            }

            // Create stat cards
            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <h3>${stat.title}</h3>
                    <div class="stat-value" style="${stat.isText ? 'font-size: 1.5rem; word-break: break-all;' : ''}">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsGrid.appendChild(card);
            });

            // Display system info
            displaySystemInfo(data);

            // Display memory types breakdown
            displayMemoryTypes(data);
        }

        // Display system info
        function displaySystemInfo(data) {
            systemInfo.innerHTML = '';

            const infoItems = [
                { label: 'Model Name', value: data.model_info?.name || data.model_name || 'Unknown' },
                { label: 'Model Host', value: data.model_info?.host || 'Unknown' },
                { label: 'Model Status', value: data.model_info?.status || 'Unknown' },
                { label: 'Server Uptime', value: formatUptime(data.uptime_seconds) || 'N/A' },
                { label: 'Total Memories', value: data.total_memories || 0 },
                { label: 'API Endpoint', value: 'http://localhost:8000' }
            ];

            infoItems.forEach(item => {
                const infoItem = document.createElement('div');
                infoItem.className = 'info-item';
                infoItem.innerHTML = `
                    <div class="info-label">${item.label}</div>
                    <div class="info-value">${item.value}</div>
                `;
                systemInfo.appendChild(infoItem);
            });
        }

        // Display memory types breakdown
        function displayMemoryTypes(data) {
            memoryTypeList.innerHTML = '';

            let memoryTypes = [];
            const total = data.total_memories || data.total_count || 0;

            // Handle different data formats and combine similar types
            const typeCounts = {};
            
            if (data.memories_by_type) {
                Object.keys(data.memories_by_type).forEach(type => {
                    const count = Array.isArray(data.memories_by_type[type]) 
                        ? data.memories_by_type[type].length 
                        : (typeof data.memories_by_type[type] === 'number' 
                            ? data.memories_by_type[type] 
                            : 0);
                    
                    // Normalize type names - combine user_fact and user_facts
                    let normalizedType = type;
                    if (type === 'user_facts') {
                        normalizedType = 'user_fact';
                    }
                    
                    // Add to existing count or create new entry
                    if (typeCounts[normalizedType]) {
                        typeCounts[normalizedType] += count;
                    } else {
                        typeCounts[normalizedType] = count;
                    }
                });
                
                // Convert to array
                Object.keys(typeCounts).forEach(type => {
                    memoryTypes.push({ type, count: typeCounts[type] });
                });
            } else if (data.types && Array.isArray(data.types)) {
                data.types.forEach(type => {
                    memoryTypes.push({ 
                        type, 
                        count: data[`${type}_count`] || 0 
                    });
                });
            }

            // Debug logging
            if (localStorage.getItem('debugMode') === 'true') {
                console.log('Memory types data:', memoryTypes);
                console.log('Type counts:', typeCounts);
                console.log('Total memories:', total);
            }

            // Sort by count descending
            memoryTypes.sort((a, b) => b.count - a.count);

            memoryTypes.forEach(item => {
                const percentage = total > 0 ? (item.count / total) * 100 : 0;
                const memoryItem = document.createElement('div');
                memoryItem.className = 'memory-type-item';
                memoryItem.innerHTML = `
                    <div class="memory-type-name">${formatTypeName(item.type)}</div>
                    <div class="memory-type-bar">
                        <div class="memory-type-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="memory-type-count">${item.count}</div>
                `;
                memoryTypeList.appendChild(memoryItem);
            });

            // Show message if no types
            if (memoryTypes.length === 0) {
                memoryTypeList.innerHTML = '<div class="info-item"><div class="info-value">No memory types found</div></div>';
            }
        }

        // Display error
        function displayError(message) {
            statsGrid.innerHTML = `
                <div class="error-message" style="grid-column: 1/-1;">
                    <h3>⚠️ Connection Error</h3>
                    <p>${message}</p>
                    <p style="margin-top: 1rem;">Make sure the server is running at http://localhost:8000</p>
                </div>
            `;
        }

        // Toggle debug mode
        async function toggleDebug(enabled) {
            // Always save locally first
            localStorage.setItem('debugMode', enabled ? 'true' : 'false');
            
            if (localStorage.getItem('debugMode') === 'true') {
                console.log('%c🐛 Debug mode ENABLED', 'color: #4a9eff; font-weight: bold; font-size: 14px;');
                console.log('Debug logs will appear in this console');
            } else {
                console.log('%c🐛 Debug mode DISABLED', 'color: #808080; font-weight: bold; font-size: 14px;');
            }
            
            // Try to notify server (optional - fails silently if endpoint doesn't exist)
            try {
                const response = await fetch('http://localhost:8000/api/debug/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: enabled
                    })
                });

                if (response.ok) {
                    console.log('✓ Server debug mode synced');
                }
            } catch (error) {
                // Silently fail - endpoint doesn't exist, which is fine
                // Debug mode is still working via localStorage
            }
        }

        // Load debug state
        function loadDebugState() {
            const debugMode = localStorage.getItem('debugMode') === 'true';
            debugToggle.checked = debugMode;
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Format uptime
        function formatUptime(seconds) {
            if (!seconds) return 'N/A';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // Format type name
        function formatTypeName(type) {
            return type
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }
    </script>
</body>
</html>
